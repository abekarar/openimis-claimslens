services:
  backend:
    extends:
      service: backend-dev
      file: compose-version.yml
  migrations:
    extends:
      service: migrations-dev
      file: compose-version.yml
  frontend:
    extends:
      service: frontend-dev
      file: compose-version.yml
  db:
    platform: linux/amd64
    image: ghcr.io/openimis/openimis-pgsql:${DB_TAG:-develop}
    environment:
      - POSTGRES_PASSWORD=${PSQL_DB_PASSWORD}
      - POSTGRES_DB=${PSQL_DB_NAME}
      - POSTGRES_USER=${PSQL_DB_USER}
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', "${PSQL_DB_USER}", '-d', "test_imis"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - database:/var/lib/postgresql/data
    restart: always
    ports:
      - 5432:5432


  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio-data:/data

  redis-claimlens:
    image: redis:7-alpine
    ports:
      - 6380:6379

  celery-claimlens:
    image: openimis-be-dev:latest
    command: ["eval", "cd /openimis-be/script && python modules-requirements.py ../openimis-dev.json > /tmp/mods.txt && pip install --quiet --cache-dir /pip-cache -r /tmp/mods.txt && cd /openimis-be/openIMIS && OPENIMIS_CONF=../openimis-dev.json celery -A openIMIS worker -l info -Q claimlens.preprocessing,claimlens.classification,claimlens.extraction"]
    environment:
      - DB_DEFAULT=postgresql
      - PSQL_DB_USER=${PSQL_DB_USER}
      - PSQL_DB_PASSWORD=${PSQL_DB_PASSWORD}
      - PSQL_DB_PORT=5432
      - PSQL_DB_ENGINE=django.db.backends.postgresql
      - PSQL_DB_HOST=db
      - PSQL_DB_NAME=${PSQL_DB_NAME}
      - CELERY_BROKER_URL=redis://redis-claimlens:6379/0
      - OPENIMIS_CONF=../openimis-dev.json
      - MODE=DEV
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
    volumes:
      - ./backend-packages:/backend-packages
      - ./backend:/openimis-be:rw
      - pip-cache:/pip-cache:rw
      - venv:/venv
      - /home/abekarar/projects/openimis-claimslens/backend:/backend-packages/openimis-be-claimlens_py
    depends_on:
      db:
        condition: service_healthy
      redis-claimlens:
        condition: service_started
      minio:
        condition: service_started
    restart: always

  db-mssql:
    image: ghcr.io/openimis/openimis-mssql:${DB_TAG:-develop}
    restart: always
    user: root
    environment:
      - DB_PASSWORD=${MSSQL_DB_PASSWORD}
      - SA_PASSWORD=${MSSQL_DB_PASSWORD}
      - DB_NAME=${MSSQL_DB_NAME}
      - DB_USER=${MSSQL_DB_USER}
      - ACCEPT_EULA=Y
      - INIT_MODE=demo
    healthcheck:
      test: "bash /app/healthcheck.sh"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 100s
    volumes:
      - database-mssql:/var/opt/mssql/data

volumes:
  database:
  database-mssql:
  nodes_volume:
  pip-cache:
  venv:
  minio-data:
