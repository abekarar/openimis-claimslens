# ClaimLens infrastructure services (MinIO, Redis, Celery worker).
# Intended to run alongside the openimis-dev-tools compose.yml, which provides
# the database and backend services. The celery-claimlens worker uses the
# openIMIS backend image and requires DB environment variables (DB_HOST, DB_PORT,
# DB_NAME, DB_USER, DB_PASSWORD) â€” these are inherited when used with
# docker compose -f ../openimis-dev-tools/compose.yml -f docker-compose.yml up.

services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio-data:/data

  redis-claimlens:
    image: redis:7-alpine
    ports:
      - 6380:6379

  celery-claimlens:
    image: ghcr.io/openimis/openimis-be:${BE_TAG:-develop}
    command: celery -A openIMIS worker -l info -Q claimlens.preprocessing,claimlens.classification,claimlens.extraction
    environment:
      - CELERY_BROKER_URL=redis://redis-claimlens:6379/0
    depends_on:
      - redis-claimlens
      - minio

volumes:
  minio-data:
